<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.26" /><meta name="theme" content="VuePress Theme Plume 1.0.0-rc.183" /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><link rel="icon" type="image/png" href="https://theme-plume.vuejs.press/favicon-32x32.png"><title>go gc流程 | 東雲研究所</title><meta name="description" content="天空又矮又圆，大地又平又方。一下跳进宇宙深空，一下钻进大陆背面。普伦西它拿着铁棒，到处敲打恶棍流氓。喵喵！"><link rel="preload" href="/assets/style-DSBhUbpT.css" as="style"><link rel="stylesheet" href="/assets/style-DSBhUbpT.css"><link rel="modulepreload" href="/assets/app-Cx00pBMU.js"><link rel="modulepreload" href="/assets/index.html-BLOnr7po.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-a29cc1ea><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-6e7e3876></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-6e7e3876> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-a29cc1ea data-v-8b3cb75f><div class="vp-navbar" vp-navbar data-v-8b3cb75f data-v-e52ba93a><div class="wrapper" data-v-e52ba93a><div class="container" data-v-e52ba93a><div class="title" data-v-e52ba93a><div class="vp-navbar-title" data-v-e52ba93a data-v-ae8e5eae><a class="vp-link link no-icon title" href="/" data-v-ae8e5eae><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="/images/sakamoto.png" alt data-v-f97f4307><!--]--><!--[--><img class="vp-image light logo" style="" src="/images/sakamoto.png" alt data-v-f97f4307><!--]--><!--]--><!--]--><span data-v-ae8e5eae>東雲研究所</span><!--[--><!--]--><!--]--></a></div></div><div class="content" data-v-e52ba93a><div class="content-body" data-v-e52ba93a><!--[--><!--]--><div class="vp-navbar-search search" data-v-e52ba93a><div class="search-wrapper" data-v-d1b35e6a><!----><div id="local-search" data-v-d1b35e6a><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-d1b35e6a><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><!--[--><!--]--><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-e52ba93a data-v-c766dd36><span id="main-nav-aria-label" class="visually-hidden" data-v-c766dd36>Main Navigation</span><!--[--><!--[--><a class="vp-link link navbar-menu-link" href="/" tabindex="0" data-v-c766dd36 data-v-d440f0f2><!--[--><!----><span data-v-d440f0f2>首页</span><!----><!--]--></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/blog/" tabindex="0" data-v-c766dd36 data-v-d440f0f2><!--[--><!----><span data-v-d440f0f2>博客</span><!----><!--]--></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/blog/tags/" tabindex="0" data-v-c766dd36 data-v-d440f0f2><!--[--><!----><span data-v-d440f0f2>标签</span><!----><!--]--></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/blog/archives/" tabindex="0" data-v-c766dd36 data-v-d440f0f2><!--[--><!----><span data-v-d440f0f2>归档</span><!----><!--]--></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/friends/" tabindex="0" data-v-c766dd36 data-v-d440f0f2><!--[--><!----><span data-v-d440f0f2>友情链接</span><!----><!--]--></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-c766dd36 data-v-388b138e><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-388b138e><span class="text" data-v-388b138e><!----><!----><span data-v-388b138e>笔记</span><!----><span class="vpi-chevron-down text-icon" data-v-388b138e></span></span></button><div class="menu" data-v-388b138e><div class="vp-menu" data-v-388b138e data-v-197ba10f><div class="items" data-v-197ba10f><!--[--><!--[--><div class="vp-menu-link" data-v-197ba10f data-v-87652438><a class="vp-link link" href="/demo/" data-v-87652438><!--[--><!----> 示例 <!----><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!--[--><!--]--><!----><div class="vp-navbar-appearance appearance" data-v-e52ba93a data-v-b1605000><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-b1605000 data-v-31b6dddc data-v-bce07b7e><span class="check" data-v-bce07b7e><span class="icon" data-v-bce07b7e><!--[--><span class="vpi-sun sun" data-v-31b6dddc></span><span class="vpi-moon moon" data-v-31b6dddc></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-e52ba93a data-v-e39e7a07 data-v-8feb9ab7><!--[--><a class="vp-social-link no-icon" href="https://github.com/shinonomeow" aria-label="github" title="github" target="_blank" rel="noopener" data-v-8feb9ab7 data-v-3ca87fef><!----></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-e52ba93a data-v-9a0c52a1 data-v-388b138e><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-388b138e><span class="vpi-more-horizontal icon" data-v-388b138e></span></button><div class="menu" data-v-388b138e><div class="vp-menu" data-v-388b138e data-v-197ba10f><!----><!--[--><!--[--><!----><div class="group" data-v-9a0c52a1><div class="item appearance" data-v-9a0c52a1><p class="label" data-v-9a0c52a1>外观</p><div class="appearance-action" data-v-9a0c52a1><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-9a0c52a1 data-v-31b6dddc data-v-bce07b7e><span class="check" data-v-bce07b7e><span class="icon" data-v-bce07b7e><!--[--><span class="vpi-sun sun" data-v-31b6dddc></span><span class="vpi-moon moon" data-v-31b6dddc></span><!--]--></span></span></button></div></div></div><div class="group" data-v-9a0c52a1><div class="item social-links" data-v-9a0c52a1><div class="vp-social-links social-links-list" data-v-9a0c52a1 data-v-8feb9ab7><!--[--><a class="vp-social-link no-icon" href="https://github.com/shinonomeow" aria-label="github" title="github" target="_blank" rel="noopener" data-v-8feb9ab7 data-v-3ca87fef><!----></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-e52ba93a data-v-085547ed><span class="container" data-v-085547ed><span class="top" data-v-085547ed></span><span class="middle" data-v-085547ed></span><span class="bottom" data-v-085547ed></span></span></button></div></div></div></div><div class="divider" data-v-e52ba93a><div class="divider-line" data-v-e52ba93a></div></div></div><!----></header><!----><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-a29cc1ea data-v-34709167><div class="vp-doc-container is-posts" data-v-34709167 data-v-e6320485><!--[--><!--]--><div class="container" data-v-e6320485><!----><div class="content" data-v-e6320485><div class="content-container" data-v-e6320485><!--[--><!--]--><main class="main" data-v-e6320485><nav class="vp-breadcrumb" data-v-e6320485 data-v-2606bfbe><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-2606bfbe><!--[--><li property="itemListElement" typeof="ListItem" data-v-2606bfbe><a class="vp-link link no-icon breadcrumb" href="/" property="item" typeof="WebPage" data-v-2606bfbe><!--[-->首页<!--]--></a><span class="vpi-chevron-right" data-v-2606bfbe></span><meta property="name" content="首页" data-v-2606bfbe><meta property="position" content="1" data-v-2606bfbe></li><li property="itemListElement" typeof="ListItem" data-v-2606bfbe><a class="vp-link link no-icon breadcrumb" href="/blog/" property="item" typeof="WebPage" data-v-2606bfbe><!--[-->Blog<!--]--></a><span class="vpi-chevron-right" data-v-2606bfbe></span><meta property="name" content="Blog" data-v-2606bfbe><meta property="position" content="2" data-v-2606bfbe></li><li property="itemListElement" typeof="ListItem" data-v-2606bfbe><a class="vp-link link no-icon breadcrumb" href="/blog/categories/?id=34d1f9" property="item" typeof="WebPage" data-v-2606bfbe><!--[-->go<!--]--></a><span class="vpi-chevron-right" data-v-2606bfbe></span><meta property="name" content="go" data-v-2606bfbe><meta property="position" content="3" data-v-2606bfbe></li><li property="itemListElement" typeof="ListItem" data-v-2606bfbe><a class="vp-link link no-icon breadcrumb current" href="/blog/qv2o0vts/" property="item" typeof="WebPage" data-v-2606bfbe><!--[-->go gc流程<!--]--></a><!----><meta property="name" content="go gc流程" data-v-2606bfbe><meta property="position" content="4" data-v-2606bfbe></li><!--]--></ol></nav><!--[--><!--]--><!--[--><div class="vp-doc-title" data-v-17748330><!--[--><!--]--><h1 class="page-title" data-v-17748330><!----> go gc流程 <!----></h1><!--[--><!--]--></div><div class="vp-doc-meta" data-v-17748330><!--[--><!--]--><p class="reading-time" data-v-17748330><span class="vpi-books icon" data-v-17748330></span><span data-v-17748330>约 1904 字</span><span data-v-17748330>大约 6 分钟</span></p><p data-v-17748330><span class="vpi-tag icon" data-v-17748330></span><!--[--><a class="vp-link link tag vp-tag-ke1p" href="/blog/tags/?tag=go" data-v-17748330><!--[-->go<!--]--></a><!--]--></p><!--[--><!--]--><p class="create-time" data-v-17748330><span class="vpi-clock icon" data-v-17748330></span><span data-v-17748330>2026-01-29</span></p></div><!--]--><!--[--><!--]--><!--[--><div class="_blog_qv2o0vts_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-e6320485><!--[--><!--]--><div data-v-e6320485><h2 id="gc-方法" tabindex="-1"><a class="header-anchor" href="#gc-方法"><span>gc 方法</span></a></h2><h3 id="标记法" tabindex="-1"><a class="header-anchor" href="#标记法"><span>标记法</span></a></h3><p>通过算法把存活的对象标记出来, 然后清理掉没有被标记的对象</p><h3 id="标记压缩" tabindex="-1"><a class="header-anchor" href="#标记压缩"><span>标记压缩</span></a></h3><p>标记法的改进版本, 在标记完成后, 把存活的对象移动到内存的一端, 然后清理掉另一端的内存</p><h3 id="半空间复制" tabindex="-1"><a class="header-anchor" href="#半空间复制"><span>半空间复制</span></a></h3><p>java 使用的 gc 方法, 把内存分成两块, 每次只使用一块, 当这一块用完后, 把存活的对象复制到另一块, 然后清理掉当前块</p><p>代价很大, 一是要两个空间, 二是要复制对象, 但是 java 使用的新生代和老年代的概念, 新生代使用半空间复制, 老年代使用标记压缩, 这样可以减少复制的代价</p><h3 id="引用计数" tabindex="-1"><a class="header-anchor" href="#引用计数"><span>引用计数</span></a></h3><p>每个对象维护一个引用计数器, 当有新的引用指向该对象时, 计数器加一, 当引用被删除时, 计数器减一, 当计数器为零时, 该对象就可以被回收</p><p>引用计数的缺点是无法处理循环引用的问题, 另外每次引用的增加和删除都要修改计数器, 代价比较大</p><p>python 使用的就是引用计数, 但是也有一个垃圾回收器, 用来处理循环引用的问题</p><h2 id="三色标记法" tabindex="-1"><a class="header-anchor" href="#三色标记法"><span>三色标记法</span></a></h2><p><img src="/assets/gc-tricolor-BfMhFI41.png" alt="三色标记法"></p><p>在 go 的 1.8 版本中, 引入了三色标记法来进行垃圾回收</p><p>Golang GC 中用到的三色标记法属于标记清扫-算法下的一种实现，由荷兰的计算机科学家 Dijkstra 提出，下面阐述要点：</p><ul><li>对象分为三种颜色标记：黑、灰、白</li><li>黑对象代表，对象自身存活，且其指向对象都已标记完成</li><li>灰对象代表，对象自身存活，但其指向对象还未标记完成</li><li>白对象代表，对象尙未被标记到，可能是垃圾对象</li><li>标记开始前，将根对象（全局对象、栈上局部变量等）置黑，将其所指向的对象置灰</li><li>标记规则是，从灰对象出发，将其所指向的对象都置灰. 所有指向对象都置灰后，当前灰对象置黑</li><li>标记结束后，白色对象就是不可达的垃圾对象，需要进行清扫.</li></ul><h3 id="stw" tabindex="-1"><a class="header-anchor" href="#stw"><span>stw</span></a></h3><p><img src="/assets/stw-B9YfStkl.webp" alt="stw"></p><p>在 golang 1.5 之前, gc 会停止用户的协程, 完成 gc 后再恢复用户协程, 这种方式叫做 stop the world, stw</p><p><img src="/assets/new-stw-D-FPBImU.webp" alt="stw"></p><p>由于这种中断可能有很长的时间, 所以在 golang 1.5 之后, 引入了并发 gc, 也就是在用户协程运行的同时, 进行 gc</p><p>并发的 gc 也不是完全没有 stw, 在某些阶段, 还是需要暂停用户协程的, 但是时间大大缩短了</p><p>不过引入了并发, 那么就要保证用户的并发安全了</p><h3 id="并发导致的问题" tabindex="-1"><a class="header-anchor" href="#并发导致的问题"><span>并发导致的问题</span></a></h3><h4 id="标记遗漏" tabindex="-1"><a class="header-anchor" href="#标记遗漏"><span>标记遗漏</span></a></h4><p><img src="/assets/mark-miss-jdIqICQr.webp" alt="标记遗漏"></p><p>现有AB两个协程, B 持有对C 的引用</p><p>GC 下 A 扫描完成, 置黑, 此时对象B是灰色</p><p>用户 A 建立了对 C 的引用</p><p>B 删除对 C 的引用</p><p>GC 继续扫描 B, 发现 B 指向 C 的引用不存在, 因为 C 没有被标记, 所以 C 被误回收</p><h4 id="标记错误-多标" tabindex="-1"><a class="header-anchor" href="#标记错误-多标"><span>标记错误,多标</span></a></h4><p><img src="/assets/mark-error-CPRwucEn.webp" alt="标记错误"></p><p>多标问题指的是在用户协程与GC协程并发执行的场景下，部分垃圾对象被误标记从而导致GC未按时将其回收的问题. 这一问题产生的过程如下：</p><p>对象 A 持有对 B 的引用</p><p>GC 扫描 A，将 B 标记为灰色</p><p>用户协程删除 A 对 B 的引用</p><p>这会导致 B 无法被 GC 正确识别为垃圾对象，从而未能及时回收，但问题不大</p><h3 id="golang-的内存碎片" tabindex="-1"><a class="header-anchor" href="#golang-的内存碎片"><span>golang 的内存碎片</span></a></h3><p>标记清扫算法会导致内存的碎片, go 的解决办法就是依靠其内存分配,把小对象分配到固定大小的内存块中, 这样就可以靠内存块的回收来解决碎片问题</p><h2 id="屏障机制" tabindex="-1"><a class="header-anchor" href="#屏障机制"><span>屏障机制</span></a></h2><p>漏标问题的本质在于一个扫描完成的黑对象指向了一个被灰/白对象删除引用的白色对象</p><ol><li><p>黑色对象指向了白色对象</p></li><li><p>灰/白对象删除了白色对象的引用</p></li><li><p>1,2 是同一个对象</p></li><li><p>1 发生在 2 之前</p></li></ol><p>一套用于解决漏标问题的方法论称之为强弱三色不变式：</p><ul><li><p>强三色不变式：白色对象不能被黑色对象直接引用（直接破坏（1））</p></li><li><p>弱三色不变式：白色对象可以被黑色对象引用，但要从某个灰对象出发仍然可达该白对象（间接破坏了（1）、（2）的联动）</p></li></ul><h2 id="插入写屏障" tabindex="-1"><a class="header-anchor" href="#插入写屏障"><span>插入写屏障</span></a></h2><p><img src="/assets/write-barrier-DeZjMZXN.webp" alt="插入写屏障"></p><p>屏障复制是指在完成某个动作前, 会先完成屏障设置的内容</p><p>插入写屏障 (Dijkstra) 的目标是实现强三色不变 保证一个黑色对象指向一个白色对象前, 会先把白色对象设为灰色, 再建立引用</p><h2 id="删除写屏障" tabindex="-1"><a class="header-anchor" href="#删除写屏障"><span>删除写屏障</span></a></h2><p><img src="/assets/delete-write-barrier-BKo490oS.webp" alt="删除写屏障"></p><p>删除写屏障( Yuasa barrier) 是实现弱弱的三色不变式 保证一个白色对象即将被上游删除引用前, 都会先置灰色, 然后再删除引用</p><h2 id="混合写屏障" tabindex="-1"><a class="header-anchor" href="#混合写屏障"><span>混合写屏障</span></a></h2><p>而在 go 里面, 这两种屏障机制都被使用, 这是因为 go 在栈空间没有使用屏障机制</p><p>原因在为栈空间的操作频繁, 如果使用插入写屏障, 会带来很大的性能开销</p><p>下面说说明混合写屏障可以解决不在栈空间使用, 依然可以保证三色不变式</p><div class="hint-container note"><p class="hint-container-title">注</p><p>go 对栈的标记是原子操作, 要么整个栈都被标记, 要么整个栈都不被标记</p></div><h3 id="case-1" tabindex="-1"><a class="header-anchor" href="#case-1"><span>case 1</span></a></h3><p><img src="/assets/case1-DkTdaO6E.webp" alt="case 1"></p><p>A 在栈上, 黑色</p><p>B 在堆上, 白色</p><p>c 在堆上, 被 B 引用, 白色</p><p>A 建立对 C 的引用, 栈对象不使用屏障,故无其他操作</p><p>B 删除对 C 的引用, 触发删除写屏障, 把 C 置灰</p><h3 id="case-2" tabindex="-1"><a class="header-anchor" href="#case-2"><span>case 2</span></a></h3><p><img src="/assets/case2-DSk_MWLV.webp" alt="case 2"> A 在堆上, 白色 B 在堆上, 黑色 C 在堆上, 被对象 B 引用, 白色</p><p>B 建立对 C 的引用, 触发插入写屏障, 把 C 置灰 A 删除对 C 的引用, C 已经是灰色, 无需操作</p><h3 id="case-3" tabindex="-1"><a class="header-anchor" href="#case-3"><span>case 3</span></a></h3><p><img src="/assets/case3-dOlPa9qa.webp" alt="case 3"></p><p>A 在栈上, 白色</p><p>B 在堆上, 黑色</p><p>C 在堆上, 被 A 引用, 白色</p><p>B 建立对 C 的引用, 触发插入写屏障, 把 C 置灰 A 删除对 C 的引用, C 已经是灰色, 无需操作</p><h3 id="case-4" tabindex="-1"><a class="header-anchor" href="#case-4"><span>case 4</span></a></h3><p><img src="/assets/case4-BwH6jjSQ.png" alt="case 4"></p><p>A 在栈上, 白色 B 在栈上, 黑色 C 在堆上, 白色, 被 A 引用</p><p>这种情况不会发生,原因如下:</p><p>I 栈对象B原先就持有C的引用，如若如此，C就必然已处于置灰状态（因为B已是黑色）</p><p>II 栈对象B持有A的引用，通过A间接找到C. 然而这也是不可能的，因为倘若A能同时被另一个栈上的B引用到，那样A必然会升级到堆中，不再满足作为一个栈对象的前提；</p><p>III B同栈内存在其他对象X可达C，此时从X出发，必然存在一个灰色对象，从其出发存在可达C的路线.</p></div><!----><!----><!----><footer class="vp-doc-footer" data-v-e6320485 data-v-25470f69><!--[--><!--]--><!----><div class="contributors" aria-label="Contributors" data-v-25470f69><span class="contributors-label" data-v-25470f69>贡献者: </span><span class="contributors-info" data-v-25470f69><!--[--><!--[--><span class="contributor" data-v-25470f69>shinonomeow</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-25470f69><div class="pager" data-v-25470f69><!----></div><div class="pager" data-v-25470f69><a class="vp-link link pager-link next" href="/blog/7ptt2dys/" data-v-25470f69><!--[--><span class="desc" data-v-25470f69>下一页</span><span class="title" data-v-25470f69><!----><span data-v-25470f69>go gmp流程</span></span><!--]--></a></div></nav></footer></div><!--]--></main><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button type="button" class="vp-back-to-top" aria-label="back to top" data-v-a29cc1ea style="display:none;" data-v-9aa440ab><span class="percent" data-allow-mismatch data-v-9aa440ab>0%</span><span class="show icon vpi-back-to-top" data-v-9aa440ab></span><svg aria-hidden="true" data-v-9aa440ab><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-9aa440ab></circle></svg></button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="sign down" class="vp-sign-down" aria-hidden="true" data-v-a29cc1ea style="display:none;" data-v-9d30c859><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" data-v-9d30c859><path d="m19 11l-7 6l-7-6" data-v-9d30c859></path><path d="m19 5l-7 6l-7-6" opacity="0.6" data-v-9d30c859></path></g></svg><footer class="vp-footer" vp-footer data-v-a29cc1ea data-v-2fe6997f><!--[--><div class="container" data-v-2fe6997f><div class="message" data-v-2fe6997f>Powered by <a target="_blank" href="https://v2.vuepress.vuejs.org/">VuePress</a> & <a target="_blank" href="https://theme-plume.vuejs.press">vuepress-theme-plume</a></div><!----></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/assets/app-Cx00pBMU.js" defer></script></body></html>