<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.26" /><meta name="theme" content="VuePress Theme Plume 1.0.0-rc.183" /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><link rel="icon" type="image/png" href="https://theme-plume.vuejs.press/favicon-32x32.png"><title>go gmp流程 | 東雲研究所</title><meta name="description" content="天空又矮又圆，大地又平又方。一下跳进宇宙深空，一下钻进大陆背面。普伦西它拿着铁棒，到处敲打恶棍流氓。喵喵！"><link rel="preload" href="/assets/style-DSBhUbpT.css" as="style"><link rel="stylesheet" href="/assets/style-DSBhUbpT.css"><link rel="modulepreload" href="/assets/app-Cx00pBMU.js"><link rel="modulepreload" href="/assets/index.html-B43vldOE.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-a29cc1ea><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-6e7e3876></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-6e7e3876> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-a29cc1ea data-v-8b3cb75f><div class="vp-navbar" vp-navbar data-v-8b3cb75f data-v-e52ba93a><div class="wrapper" data-v-e52ba93a><div class="container" data-v-e52ba93a><div class="title" data-v-e52ba93a><div class="vp-navbar-title" data-v-e52ba93a data-v-ae8e5eae><a class="vp-link link no-icon title" href="/" data-v-ae8e5eae><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="/images/sakamoto.png" alt data-v-f97f4307><!--]--><!--[--><img class="vp-image light logo" style="" src="/images/sakamoto.png" alt data-v-f97f4307><!--]--><!--]--><!--]--><span data-v-ae8e5eae>東雲研究所</span><!--[--><!--]--><!--]--></a></div></div><div class="content" data-v-e52ba93a><div class="content-body" data-v-e52ba93a><!--[--><!--]--><div class="vp-navbar-search search" data-v-e52ba93a><div class="search-wrapper" data-v-d1b35e6a><!----><div id="local-search" data-v-d1b35e6a><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-d1b35e6a><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><!--[--><!--]--><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-e52ba93a data-v-c766dd36><span id="main-nav-aria-label" class="visually-hidden" data-v-c766dd36>Main Navigation</span><!--[--><!--[--><a class="vp-link link navbar-menu-link" href="/" tabindex="0" data-v-c766dd36 data-v-d440f0f2><!--[--><!----><span data-v-d440f0f2>首页</span><!----><!--]--></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/blog/" tabindex="0" data-v-c766dd36 data-v-d440f0f2><!--[--><!----><span data-v-d440f0f2>博客</span><!----><!--]--></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/blog/tags/" tabindex="0" data-v-c766dd36 data-v-d440f0f2><!--[--><!----><span data-v-d440f0f2>标签</span><!----><!--]--></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/blog/archives/" tabindex="0" data-v-c766dd36 data-v-d440f0f2><!--[--><!----><span data-v-d440f0f2>归档</span><!----><!--]--></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/friends/" tabindex="0" data-v-c766dd36 data-v-d440f0f2><!--[--><!----><span data-v-d440f0f2>友情链接</span><!----><!--]--></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-c766dd36 data-v-388b138e><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-388b138e><span class="text" data-v-388b138e><!----><!----><span data-v-388b138e>笔记</span><!----><span class="vpi-chevron-down text-icon" data-v-388b138e></span></span></button><div class="menu" data-v-388b138e><div class="vp-menu" data-v-388b138e data-v-197ba10f><div class="items" data-v-197ba10f><!--[--><!--[--><div class="vp-menu-link" data-v-197ba10f data-v-87652438><a class="vp-link link" href="/demo/" data-v-87652438><!--[--><!----> 示例 <!----><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!--[--><!--]--><!----><div class="vp-navbar-appearance appearance" data-v-e52ba93a data-v-b1605000><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-b1605000 data-v-31b6dddc data-v-bce07b7e><span class="check" data-v-bce07b7e><span class="icon" data-v-bce07b7e><!--[--><span class="vpi-sun sun" data-v-31b6dddc></span><span class="vpi-moon moon" data-v-31b6dddc></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-e52ba93a data-v-e39e7a07 data-v-8feb9ab7><!--[--><a class="vp-social-link no-icon" href="https://github.com/shinonomeow" aria-label="github" title="github" target="_blank" rel="noopener" data-v-8feb9ab7 data-v-3ca87fef><!----></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-e52ba93a data-v-9a0c52a1 data-v-388b138e><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-388b138e><span class="vpi-more-horizontal icon" data-v-388b138e></span></button><div class="menu" data-v-388b138e><div class="vp-menu" data-v-388b138e data-v-197ba10f><!----><!--[--><!--[--><!----><div class="group" data-v-9a0c52a1><div class="item appearance" data-v-9a0c52a1><p class="label" data-v-9a0c52a1>外观</p><div class="appearance-action" data-v-9a0c52a1><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-9a0c52a1 data-v-31b6dddc data-v-bce07b7e><span class="check" data-v-bce07b7e><span class="icon" data-v-bce07b7e><!--[--><span class="vpi-sun sun" data-v-31b6dddc></span><span class="vpi-moon moon" data-v-31b6dddc></span><!--]--></span></span></button></div></div></div><div class="group" data-v-9a0c52a1><div class="item social-links" data-v-9a0c52a1><div class="vp-social-links social-links-list" data-v-9a0c52a1 data-v-8feb9ab7><!--[--><a class="vp-social-link no-icon" href="https://github.com/shinonomeow" aria-label="github" title="github" target="_blank" rel="noopener" data-v-8feb9ab7 data-v-3ca87fef><!----></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-e52ba93a data-v-085547ed><span class="container" data-v-085547ed><span class="top" data-v-085547ed></span><span class="middle" data-v-085547ed></span><span class="bottom" data-v-085547ed></span></span></button></div></div></div></div><div class="divider" data-v-e52ba93a><div class="divider-line" data-v-e52ba93a></div></div></div><!----></header><!----><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-a29cc1ea data-v-34709167><div class="vp-doc-container is-posts" data-v-34709167 data-v-e6320485><!--[--><!--]--><div class="container" data-v-e6320485><!----><div class="content" data-v-e6320485><div class="content-container" data-v-e6320485><!--[--><!--]--><main class="main" data-v-e6320485><nav class="vp-breadcrumb" data-v-e6320485 data-v-2606bfbe><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-2606bfbe><!--[--><li property="itemListElement" typeof="ListItem" data-v-2606bfbe><a class="vp-link link no-icon breadcrumb" href="/" property="item" typeof="WebPage" data-v-2606bfbe><!--[-->首页<!--]--></a><span class="vpi-chevron-right" data-v-2606bfbe></span><meta property="name" content="首页" data-v-2606bfbe><meta property="position" content="1" data-v-2606bfbe></li><li property="itemListElement" typeof="ListItem" data-v-2606bfbe><a class="vp-link link no-icon breadcrumb" href="/blog/" property="item" typeof="WebPage" data-v-2606bfbe><!--[-->Blog<!--]--></a><span class="vpi-chevron-right" data-v-2606bfbe></span><meta property="name" content="Blog" data-v-2606bfbe><meta property="position" content="2" data-v-2606bfbe></li><li property="itemListElement" typeof="ListItem" data-v-2606bfbe><a class="vp-link link no-icon breadcrumb" href="/blog/categories/?id=34d1f9" property="item" typeof="WebPage" data-v-2606bfbe><!--[-->go<!--]--></a><span class="vpi-chevron-right" data-v-2606bfbe></span><meta property="name" content="go" data-v-2606bfbe><meta property="position" content="3" data-v-2606bfbe></li><li property="itemListElement" typeof="ListItem" data-v-2606bfbe><a class="vp-link link no-icon breadcrumb current" href="/blog/7ptt2dys/" property="item" typeof="WebPage" data-v-2606bfbe><!--[-->go gmp流程<!--]--></a><!----><meta property="name" content="go gmp流程" data-v-2606bfbe><meta property="position" content="4" data-v-2606bfbe></li><!--]--></ol></nav><!--[--><!--]--><!--[--><div class="vp-doc-title" data-v-17748330><!--[--><!--]--><h1 class="page-title" data-v-17748330><!----> go gmp流程 <!----></h1><!--[--><!--]--></div><div class="vp-doc-meta" data-v-17748330><!--[--><!--]--><p class="reading-time" data-v-17748330><span class="vpi-books icon" data-v-17748330></span><span data-v-17748330>约 2678 字</span><span data-v-17748330>大约 9 分钟</span></p><p data-v-17748330><span class="vpi-tag icon" data-v-17748330></span><!--[--><a class="vp-link link tag vp-tag-ke1p" href="/blog/tags/?tag=go" data-v-17748330><!--[-->go<!--]--></a><!--]--></p><!--[--><!--]--><p class="create-time" data-v-17748330><span class="vpi-clock icon" data-v-17748330></span><span data-v-17748330>2026-01-23</span></p></div><!--]--><!--[--><!--]--><!--[--><div class="_blog_7ptt2dys_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-e6320485><!--[--><!--]--><div data-v-e6320485><p>本文是对 小徐先生 的 gmp 原理解析的一些阅读笔记</p><h2 id="为什么要引入-gmp" tabindex="-1"><a class="header-anchor" href="#为什么要引入-gmp"><span>为什么要引入 gmp</span></a></h2><p>在协程之前, 采用的是线程模型, 线程也是操作系统对应的最小调度单元, 但是线程对于一些任务来说还是太重了</p><p>创建一个新的线程, 操作系统会分配一个 8MB 的栈空间, 而且线程之间的切换也都要从用户态切换到内核态, 代价比较高</p><p>于是 很多语言引入了协程的概念, 协程是用户态的轻量级线程, 由用户自己调度, 代价比较小, 也不需要分配那么大的栈空间</p><p>coroutine 在 python 的实现由该协程主动交出控制权, 这种方式让用户比操作线程有更多的控制权, 但是也要求用户对自己的代码负责, 不能阻塞协程</p><p>go 则是对 coroutine 做了一定的改动, 由 go 来分配协程之前的调度, 更加像一个线程了.</p><h2 id="gmp-模型" tabindex="-1"><a class="header-anchor" href="#gmp-模型"><span>gmp 模型</span></a></h2><p>goroutine 的强依赖于 go 设计的 gmp 模型的</p><p>gmp 分别是</p><ul><li>g : goroutine, 代表一个协程</li><li>m : machine, 代表一个操作系统线程</li><li>p : processor, 代表一个逻辑处理器, 负责调度 g 到 m 上运行</li></ul><p>[!NOTE]</p><blockquote><p>可以说 go 完全屏蔽了线程的概念, 让用户的操作都以 g 为粒度, 统一了并发操作</p></blockquote><h3 id="g" tabindex="-1"><a class="header-anchor" href="#g"><span>g</span></a></h3><p>g 代表 go 中的 协程, 有自己的运行栈,生命周期和执行任务函数</p><p>g 一定要绑定到 m 上执行</p><h3 id="m" tabindex="-1"><a class="header-anchor" href="#m"><span>m</span></a></h3><p>m 是 go 中对线程的一个抽象, m 要和 p 绑定后才能执行 g</p><p>m 中有一个 g0, 这就是对 g 的一个抽象, 用来找任务, 然后执行 g</p><h3 id="p" tabindex="-1"><a class="header-anchor" href="#p"><span>p</span></a></h3><p>p processor, 是 golang 中的调度器</p><p>p 为 m 到执行代理, m 要与 p 绑定后, 才会进入到调度中； 因此 p 的数量决定了 g 的最大并行数量(由 GOMAXPROCS 控制, 默认等于 CPU 核心数)</p><p>p 自带了一个本地 g 队列, 用来存放等待被调度的 g <img src="/assets/gmp-BzhtMNDQ.jpg" alt="gmp示意图"></p><p>g 内部有一个本地队列 lrq ( local run queue ), 用来存放本地的 g, 有一个本地队列的好处是减少了竞争 但也并不是一个完全的并发, 因为还有偷取功能, 导致并不能完全没有竞争</p><p>其次有一个全局队列, 当某个 lrq 不满足条件时, 会从全局队列中获取 g,</p><h2 id="put-and-get" tabindex="-1"><a class="header-anchor" href="#put-and-get"><span>put and get</span></a></h2><p>put g: 当一个 g 被创建时, 会先放到 p 的 lrq 中, 如果 lrq 满了, 会放到全局队列中</p><p>get g: 当 m 与 p 结合后, g0 会不断的找合适的 g 用来执行, 此时会采取 &quot;负载&quot; 均衡的方式来获取 g</p><ul><li>优先从当前 p 的 lrq 中获取 g</li><li>从全局队列中获取 g</li><li>取 io 就绪的 g (netpoll)</li><li>从其他 p 的 lrq 中偷取 g</li></ul><div class="hint-container note"><p class="hint-container-title">注</p><p>g0 在每 61 次出席的时候, 会尝试从全局队列中获取 g, 以防止 lrq 中 g 太多, grq 饥饿</p></div><h2 id="gmp-数据结构" tabindex="-1"><a class="header-anchor" href="#gmp-数据结构"><span>gmp 数据结构</span></a></h2><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">type</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> g</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> struct</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    stack</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">   stack</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   // 运行栈</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    stackguard0</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> uintptr</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 栈保护</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    _panic</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    *</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">_panic</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 当前 panic</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    _defer</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    *</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">_defer</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // defer 列表</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    m</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">         *</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">m</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // 绑定的 m</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    atomicstatus</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> uint32</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // g 的生命状态</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中要注意的几个参数</p><ul><li><p>stackguard0: 这是栈保护区的边界, 也是用来传递抢占标识的 比如当前的 goroutine 不该运行了, 那么会在这个边界上设置一个抢占标识, 当 这个 goroutine 的栈进行扩充时, 检测到了这个标识, 就会自己让出 CPU, 不过这是主动的, 被动的还有一些不一样</p></li><li><p>defer: 创建的 defer 链表</p></li><li><p>m 当前的执行 g 的 m</p></li><li><p>一个 goroutine 有五个状态, 分别是 Idle, Dead, Runnable, Running, Waiting, 其流转如图</p></li></ul><p><img src="/assets/atomicstatus-zq_5PzdW.webp" alt="atomicstatus"></p><h2 id="m-详设" tabindex="-1"><a class="header-anchor" href="#m-详设"><span>m 详设</span></a></h2><p>m 为 go 对线程的抽象, 其核心成员为</p><ul><li>g0: 特殊的 g, 不由用户创建, 与 m 为一对一的</li><li>gsignal: 用来处理信号的 g</li><li>curg: 当前正在执行的 g</li><li>p: 与m绑定的 p</li></ul><p>m 的运行目标为 g0 和 g, 两者交替进行；g0 的作用是用来寻找需要执行的 g, g 是 g0 找到并分配给 m 执行的任务</p><h2 id="p-详设" tabindex="-1"><a class="header-anchor" href="#p-详设"><span>p 详设</span></a></h2><p>p 是 gmp 的调度器, 其核心成员为</p><ul><li>status: p 生命周期状态</li><li>m: 当前和 p 结合的 m</li><li>runq: p 私有的 g 队列 - local run queue(lrq)</li><li>runqhead: lrq 中队首的节点的索引</li><li>runqtail: lrq 中队尾节点的索引</li><li>runnext: lrq 中的特定席, 指向下一个要执行的 g</li></ul><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">type</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> p</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> struct</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    id</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">          int32</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    /*</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        p 的状态</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // p 因缺少 g 而进入空闲模式，此时会被添加到全局的 idle p 队列中</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        _Pidle = iota // 0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // p 正在运行中，被 m 所持有，可能在运行普通 g，也可能在运行 g0</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        _Prunning // 1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // p 所关联的 m 正在执行系统调用. 此时 p 可能被窃取并与其他 m 关联</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        _Psyscall // 2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // p 已被终止</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        _Pdead // 4</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    */</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    status</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      uint32</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// one of pidle/prunning/...</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 进入 schedt pidle 链表时指向相邻 p 的 next 指针</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    link</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">        puintptr</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // p 所关联的 m. 若 p 为 idle 状态，可能为 nil</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    m</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">           muintptr</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   // back-link to associated m (nil if idle)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // lrq 的队首</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    runqhead</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> uint32</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // lrq 的队尾</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    runqtail</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> uint32</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // q 的本地 g 队列——lrq</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    runq</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">     [</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">256</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">guintptr</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 下一个调度的 g. 可以理解为 lrq 中的特等席</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    runnext</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> guintptr</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="schedt-详设" tabindex="-1"><a class="header-anchor" href="#schedt-详设"><span>schedt 详设</span></a></h3><p>schedt 是全局的资源模块, 在访问前要加全局锁</p><ul><li>lock: 全局的互斥锁</li><li>midle: 空闲 m 队列</li><li>pidle: 空闲 p 队列</li><li>runq: 全局 g 队列 global run queue(grq) -runqsize: grq 中存在的 g 数量</li></ul><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 全局调度模块</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">type</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> schedt</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> struct</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 互斥锁</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    lock</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> mutex</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 空闲 m 队列</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    midle</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">        muintptr</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // idle m&#39;s waiting for work</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 空闲 p 队列</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    pidle</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">      puintptr</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // idle p&#39;s</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 全局 g 队列——grq</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    runq</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">     gQueue</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // grq 中存量 g 的个数</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    runqsize</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> int32</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container note"><p class="hint-container-title">注</p><p>之所以存在 midle 和 pidle 的设计, 是为了避免 p 和 m 因为缺少 g 而导致 cpu 空转 对于空闲的 p 和 m, 会被集成到空闲队列中, 并且会暂停 m 的运行</p></div><h2 id="调度原理" tabindex="-1"><a class="header-anchor" href="#调度原理"><span>调度原理</span></a></h2><h3 id="main-函数" tabindex="-1"><a class="header-anchor" href="#main-函数"><span>main 函数</span></a></h3><p>文中说这是一个特殊的, 由全局唯一的 m0 来执行, 但并不是很懂有什么用</p><h3 id="g-的调度" tabindex="-1"><a class="header-anchor" href="#g-的调度"><span>g 的调度</span></a></h3><p><img src="/assets/g-schedule-Dk7W--PH.webp" alt="g 调度流程图"></p><p>用户通过 go func 创建的 goroutine, 都会以 g 的形式进入到 gmp 中</p><p>加入的顺序为</p><ul><li>如果当前的 p 的 lrq 没有满, 则放入 lrq 中</li><li>否则放入全局的 grq 中(这里要加锁)</li></ul><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 创建一个新的 g, 入参为用户的函数 fn</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 当前执行的是一个普通的 g</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">func</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> newproc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fn</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">funcval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 获取当前正在执行的普通 g 及 程序计数器 pc (program counter)</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> gp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> :=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getg</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> pc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> :=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> sys</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">GetCallerPC</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// systemstack 会临时切换到 g0 来执行, 当执行完毕后, 切换回原 g</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> systemstack</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">func</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 这里相比 1.9 版本, 多了 false 和 waitReasonZero 两个参数</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// false 表示这个 g 不是系统 g</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// waitReasonZero 表示这个 g 没有特殊的等待原因</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  newg</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> :=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> newproc1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fn</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> gp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> pc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> waitReasonZero</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//获取当前的p</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  pp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> :=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> getg</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">m</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">p</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ptr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  runqput</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">pp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> newg</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 如果存在因过度空闲而被 block 的 p 和 m，则需要对其进行唤醒</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  if</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> mainStarted</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   wakep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;"> })</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其核心的 runqput 为</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 将 gp 放入 pp 的本地运行队列中</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 如果 next 为 true, 则将 gp 放入 runnext 特等席中</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 如果 lrq 满了, 则放入全局 grq 中</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">func</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> runqput</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">pp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">p</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> gp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">g</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> next</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> bool</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> if</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">haveSysmon</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> next</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // runnext goroutine 和当前的 goroutine 共享同一个时间片</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 这是为了 A-&gt;B-&gt;A 这种切换导致其他的 goroutine 饥饿</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  next</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> if</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> randomizeScheduler</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> next</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> randn</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ==</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  next</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> if</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> next</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> retryNext</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  oldnext</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> :=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> pp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">runnext</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  if</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">pp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">runnext</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cas</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">oldnext</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> guintptr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">unsafe</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Pointer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">gp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">   goto</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> retryNext</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  if</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> oldnext</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ==</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">   return</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // Kick the old runnext out to the regular run queue.</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  gp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> oldnext</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ptr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">retry</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> h</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> :=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> atomic</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">LoadAcq</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&amp;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">pp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">runqhead</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // load-acquire, synchronize with consumers</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> t</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> :=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> pp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">runqtail</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 如果没有满的话, 放入到末尾</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> if</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> t</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">-</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">h</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> uint32</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">len</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">pp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">runq</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  pp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">runq</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">t</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">%uint32</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">len</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">pp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">runq</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))].</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">set</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">gp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  atomic</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">StoreRel</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&amp;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">pp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">runqtail</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> t</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // store-release, makes the item available for consumption</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  return</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 这会把 g 和 一半的 lrq 中的 g 一起放入到全局 grq 中</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> if</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> runqputslow</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">pp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> gp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> h</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> t</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  return</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // the queue is not full, now the put above must succeed</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> goto</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> retry</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>几个要注意的点</p><ul><li>CAS 操作, 这是一个原子操作, 用来把两个值进行比较, 如果相等则赋值</li></ul><h3 id="g0-和-g-之间的调度" tabindex="-1"><a class="header-anchor" href="#g0-和-g-之间的调度"><span>g0 和 g 之间的调度</span></a></h3><p>在每个 m 中会有一个与之伴生的 g0，其任务就是不断寻找可执行的 g. 所以对一个 m 来说，其运行周期就是处在 g0 与 g 之间轮换交替的过程中.</p><p>在 m 运行中，能够通过几个桩方法实现 g0 与 g 之间执行权的切换:</p><ul><li><p>g -&gt; g0：mcall、systemstack</p></li><li><p>g0 -&gt; g：gogo</p></li></ul><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 从 g 切换至 g0 执行. 只允许在 g 中调用</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">func</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> mcall</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fn</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> func</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">g</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 在普通 g 中调用时，会切换至 g0 压栈执行 fn，执行完成后切回到 g</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">func</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> systemstack</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fn</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> func</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">())</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 从 g0 切换至 g 执行. gobuf 包含 g 运行上下文信息</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">func</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> gogo</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">buf</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">gobuf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>go 执行两个核心方法来切换到 g</p><ul><li>schedule: 调用 findRunnable 方法,获取到可执行的 g</li><li>exexute: 更新 g 的上下文信息, 调用 gogo 方法, 将 m 的执行权从 go 切换到 g</li></ul><h2 id="抢占设计" tabindex="-1"><a class="header-anchor" href="#抢占设计"><span>抢占设计</span></a></h2><p>go 语言对协程的改进就在于引入了抢占式调度, 也就是说 g 不再是完全主动交出控制权的</p><h3 id="监控线程" tabindex="-1"><a class="header-anchor" href="#监控线程"><span>监控线程</span></a></h3><p>在 go 程序运行时，会启动一个全局唯一的监控线程——sysmon thread，其负责定时执行监控工作，主要包括：</p><ul><li>执行 netpoll 操作，唤醒 io 就绪的 g</li><li>执行 retake 操作，对运行时间过长的 g 执行抢占操作</li><li>执行 gcTrigger 操作，探测是否需要发起新的 gc 轮次</li></ul><h3 id="系统调用" tabindex="-1"><a class="header-anchor" href="#系统调用"><span>系统调用</span></a></h3><p>当一个 g 进入系统调用时, 会把当前的 p 与 m 分离, 让出 p 给其他的 m 使用</p><p>系统调用的时候, 线程没有能力去自己切换, 所以要把 p 让出来</p><h3 id="运行超时" tabindex="-1"><a class="header-anchor" href="#运行超时"><span>运行超时</span></a></h3><p>当有一个 g 运行超过了 10ms, sysmon 会设置该 g 的抢占标识, 让其在下次栈扩充时, 主动交出控制权</p><p>go 1.14 之后, 引入了异步抢占的设计, 也就是说不需要等到栈扩充时才抢占, 而是直接通过修改 pc 寄存器的值, 改变了 g 的下一个指令, 来让 g 进入调度状态</p></div><!----><!----><!----><footer class="vp-doc-footer" data-v-e6320485 data-v-25470f69><!--[--><!--]--><!----><div class="contributors" aria-label="Contributors" data-v-25470f69><span class="contributors-label" data-v-25470f69>贡献者: </span><span class="contributors-info" data-v-25470f69><!--[--><!--[--><span class="contributor" data-v-25470f69>shinonomeow</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-25470f69><div class="pager" data-v-25470f69><a class="vp-link link pager-link prev" href="/blog/qv2o0vts/" data-v-25470f69><!--[--><span class="desc" data-v-25470f69>上一页</span><span class="title" data-v-25470f69><!----><span data-v-25470f69>go gc流程</span></span><!--]--></a></div><div class="pager" data-v-25470f69><a class="vp-link link pager-link next" href="/blog/5ysbxanu/" data-v-25470f69><!--[--><span class="desc" data-v-25470f69>下一页</span><span class="title" data-v-25470f69><!----><span data-v-25470f69>http</span></span><!--]--></a></div></nav></footer></div><!--]--></main><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button type="button" class="vp-back-to-top" aria-label="back to top" data-v-a29cc1ea style="display:none;" data-v-9aa440ab><span class="percent" data-allow-mismatch data-v-9aa440ab>0%</span><span class="show icon vpi-back-to-top" data-v-9aa440ab></span><svg aria-hidden="true" data-v-9aa440ab><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-9aa440ab></circle></svg></button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="sign down" class="vp-sign-down" aria-hidden="true" data-v-a29cc1ea style="display:none;" data-v-9d30c859><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" data-v-9d30c859><path d="m19 11l-7 6l-7-6" data-v-9d30c859></path><path d="m19 5l-7 6l-7-6" opacity="0.6" data-v-9d30c859></path></g></svg><footer class="vp-footer" vp-footer data-v-a29cc1ea data-v-2fe6997f><!--[--><div class="container" data-v-2fe6997f><div class="message" data-v-2fe6997f>Powered by <a target="_blank" href="https://v2.vuepress.vuejs.org/">VuePress</a> & <a target="_blank" href="https://theme-plume.vuejs.press">vuepress-theme-plume</a></div><!----></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/assets/app-Cx00pBMU.js" defer></script></body></html>